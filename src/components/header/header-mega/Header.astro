---
import './Header.css';
import ButtonPrimaryDark from '../../buttons/primary-dark/ButtonPrimaryDark.astro';
import { loadT, getLangFromUrl, type Locale } from '../../../i18n';
import { getCollection } from 'astro:content';

interface Props { lang?: Locale }
const { lang: langProp } = Astro.props as Props;
const lang: Locale = langProp ?? getLangFromUrl(Astro.url);
const t = await loadT(lang, ['header', 'megamenu']);

// Detectar si la página tiene hero/banner desde el servidor
const isHomePage = Astro.url.pathname === '/' || 
                  Astro.url.pathname.match(/^\/(es|en|ca)\/?$/);
const hasPageHero = Astro.url.pathname.includes('/contacto') || 
                   Astro.url.pathname.includes('/servicios/') ||
                   Astro.url.pathname.includes('/despacho');
const is404Page = Astro.url.pathname === '/404' || Astro.url.pathname.endsWith('/404');
const shouldBeTransparent = (isHomePage || hasPageHero) && !is404Page;

// Clases CSS para el header
const headerClasses = shouldBeTransparent ? 'home-page' : 'no-hero';

// Fallback translations para header si el sistema no funciona
const headerFallback = {
  es: {
    nav: {
      home: "Inicio",
      despacho: "Despacho",
      servicios: "Servicios",
      blog: "Blog",
      contacto: "Contacto"
    },
    actions: {
      talk: "¿Hablamos?"
    }
  },
  en: {
    nav: {
      home: "Home",
      despacho: "Firm",
      servicios: "Services",
      blog: "Blog",
      contacto: "Contact"
    },
    actions: {
      talk: "Let's talk"
    }
  },
  ca: {
    nav: {
      home: "Inici",
      despacho: "Despatx",
      servicios: "Serveis",
      blog: "Blog",
      contacto: "Contacte"
    },
    actions: {
      talk: "Parlem?"
    }
  }
};

// Función helper para obtener traducciones de header con fallback
function getHeaderTranslation(key: string) {
  const translation = t(`header.${key}`);
  if (translation === `header.${key}`) {
    // Si no se encuentra la traducción, usar fallback
    const keys = key.split('.');
    let value: any = headerFallback[lang];
    for (const k of keys) {
      value = value?.[k];
    }
    return value || key;
  }
  return translation;
}

// Fallback translations para megamenu si el sistema no funciona
const megamenuFallback = {
  es: {
    title: "Servicios",
    services: {
      fiscal: {
        title: "Fiscal y Contable",
        description: "Asesoramiento fiscal integral, contabilidad empresarial y optimización tributaria para empresas y particulares."
      },
      laboral: {
        title: "Laboral",
        description: "Derecho laboral, contratos, despidos, negociación colectiva y asesoramiento en recursos humanos."
      },
      mercantil: {
        title: "Mercantil y Societario",
        description: "Constitución de empresas, fusiones, adquisiciones, contratos mercantiles y derecho corporativo."
      },
      sucesiones: {
        title: "Sucesiones",
        description: "Planificación sucesoria, testamentos, herencias, liquidación de impuestos y gestión patrimonial."
      }
    },
    legal: {
      privacy: "Política de Privacidad",
      terms: "Términos y Condiciones",
      legal: "Aviso Legal"
    }
  },
  en: {
    title: "Services",
    services: {
      fiscal: {
        title: "Tax and Accounting",
        description: "Comprehensive tax advice, business accounting and tax optimization for companies and individuals."
      },
      laboral: {
        title: "Labor Law",
        description: "Labor law, contracts, dismissals, collective bargaining and human resources consulting."
      },
      mercantil: {
        title: "Commercial and Corporate",
        description: "Company formation, mergers, acquisitions, commercial contracts and corporate law."
      },
      sucesiones: {
        title: "Inheritance",
        description: "Succession planning, wills, inheritances, tax settlement and wealth management."
      }
    },
    legal: {
      privacy: "Privacy Policy",
      terms: "Terms and Conditions",
      legal: "Legal Notice"
    }
  },
  ca: {
    title: "Serveis",
    services: {
      fiscal: {
        title: "Fiscal i Comptable",
        description: "Assessorament fiscal integral, comptabilitat empresarial i optimització tributària per a empreses i particulars."
      },
      laboral: {
        title: "Laboral",
        description: "Dret laboral, contractes, acomiadaments, negociació col·lectiva i assessorament en recursos humans."
      },
      mercantil: {
        title: "Mercantil i Societari",
        description: "Constitució d'empreses, fusions, adquisicions, contractes mercantils i dret corporatiu."
      },
      sucesiones: {
        title: "Successions",
        description: "Planificació successòria, testaments, herències, liquidació d'impostos i gestió patrimonial."
      }
    },
    legal: {
      privacy: "Política de Privacitat",
      terms: "Termes i Condicions",
      legal: "Avís Legal"
    }
  }
};

// Función helper para obtener traducciones del megamenu con fallback
function getMegamenuTranslation(key: string) {
  const translation = t(`megamenu.${key}`);
  if (translation === `megamenu.${key}`) {
    // Si no se encuentra la traducción, usar fallback
    const keys = key.split('.');
    let value = megamenuFallback[lang];
    for (const k of keys) {
      value = value?.[k];
    }
    return value || key;
  }
  return translation;
}

// Obtener posts para manejar traducciones del blog
const allPosts = await getCollection('blog');

// Función para manejar las rutas del blog
function getBlogTranslationUrl(currentLang: Locale, targetLang: Locale, currentPath: string): string {
  // Si estamos en una ruta de blog individual (/es/blog/slug o /en/blog/slug)
  const blogMatch = currentPath.match(/^\/(es|en|ca)\/blog\/(.+)$/);
  if (blogMatch) {
    const [, currentBlogLang, slug] = blogMatch;
    
    // Buscar el post actual para obtener sus traducciones
    const currentPost = allPosts.find(p => p.id === `${currentBlogLang}/${slug}.mdx`);
    
    if (currentPost && currentPost.data.translations && currentPost.data.translations[targetLang]) {
      // Si existe traducción, ir al post traducido
      return `/${targetLang}/blog/${currentPost.data.translations[targetLang]}`;
    } else {
      // Si no hay traducción, ir al blog del idioma objetivo
      return `/${targetLang}/blog`;
    }
  }
  
  // Si estamos en la página de blog (/es/blog o /en/blog)
  if (currentPath.match(/^\/(es|en|ca)\/blog\/?$/)) {
    return `/${targetLang}/blog`;
  }
  
  // Para cualquier otra ruta, cambiar solo el prefijo
  return currentPath.replace(/^\/(es|en|ca)/, `/${targetLang}`);
}

const toES = getBlogTranslationUrl(lang, 'es', Astro.url.pathname);
const toEN = getBlogTranslationUrl(lang, 'en', Astro.url.pathname);
const toCA = getBlogTranslationUrl(lang, 'ca', Astro.url.pathname);
const prefix = `/${lang}`;
---

<header class={`header-mega ${headerClasses}`} data-lang={lang}>
  <div class="container">
    <div class="header-mega-content">
      <div class="logo">
        <a href={`${prefix}/`}>
          <img src="/images/logo.svg" alt="Logo" class="logo-img" />
        </a>
      </div>
      
      <nav class="nav-mega desktop-nav">
        <div class="nav-item-mega">
          <a href={`${prefix}/`} class="nav-link-mega">{t('nav.home')}</a>
        </div>
        <div class="nav-item-mega dropdown-mega">
          <a href={`${prefix}/servicios`} class="nav-link-mega">
            {t('nav.servicios')}
            <svg class="dropdown-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M6 9l6 6 6-6"/></svg>
          </a>
          <div class="mega-menu">
            <div class="mega-menu-header">
              <div class="mega-menu-title">{getMegamenuTranslation('title')}</div>
            </div>
            <div class="mega-menu-content">
              <a href={`${prefix}/servicios/fiscal`} class="mega-menu-item">
                <div class="mega-menu-image">
                  <img src="/images/megamenu/fiscal.webp" alt={getMegamenuTranslation('services.fiscal.title')} />
                </div>
                <div class="mega-menu-text">
                  <div class="mega-menu-service-title">{getMegamenuTranslation('services.fiscal.title')}</div>
                  <p>{getMegamenuTranslation('services.fiscal.description')}</p>
                </div>
              </a>
              <a href={`${prefix}/servicios/laboral`} class="mega-menu-item">
                <div class="mega-menu-image">
                  <img src="/images/megamenu/laboral.webp" alt={getMegamenuTranslation('services.laboral.title')} />
                </div>
                <div class="mega-menu-text">
                  <div class="mega-menu-service-title">{getMegamenuTranslation('services.laboral.title')}</div>
                  <p>{getMegamenuTranslation('services.laboral.description')}</p>
                </div>
              </a>
              <a href={`${prefix}/servicios/mercantil-societario`} class="mega-menu-item">
                <div class="mega-menu-image">
                  <img src="/images/megamenu/mercantil.webp" alt={getMegamenuTranslation('services.mercantil.title')} />
                </div>
                <div class="mega-menu-text">
                  <div class="mega-menu-service-title">{getMegamenuTranslation('services.mercantil.title')}</div>
                  <p>{getMegamenuTranslation('services.mercantil.description')}</p>
                </div>
              </a>
              <a href={`${prefix}/servicios/sucesiones`} class="mega-menu-item">
                <div class="mega-menu-image">
                  <img src="/images/megamenu/sucesiones.webp" alt={getMegamenuTranslation('services.sucesiones.title')} />
                </div>
                <div class="mega-menu-text">
                  <div class="mega-menu-service-title">{getMegamenuTranslation('services.sucesiones.title')}</div>
                  <p>{getMegamenuTranslation('services.sucesiones.description')}</p>
                </div>
              </a>
            </div>
            <div class="mega-menu-separator"></div>
            <div class="mega-menu-footer">
              <a href={`${prefix}/politica-privacidad`}>{getMegamenuTranslation('legal.privacy')}</a>
              <a href={`${prefix}/terminos-condiciones`}>{getMegamenuTranslation('legal.terms')}</a>
              <a href={`${prefix}/aviso-legal`}>{getMegamenuTranslation('legal.legal')}</a>
            </div>
          </div>
        </div>
        
        <div class="nav-item-mega">
          <a href={`${prefix}/despacho`} class="nav-link-mega">{t('nav.despacho')}</a>
        </div>
        
        <div class="nav-item-mega">
          <a href={`${prefix}/blog`} class="nav-link-mega">Blog</a>
        </div>
        
        <div class="nav-item-mega">
          <a href={`${prefix}/contacto`} class="nav-link-mega">{getHeaderTranslation('nav.contacto')}</a>
        </div>
      </nav>
      
      <div class="header-mega-actions">
        <div class="lang-dropdown" aria-label="Language selector" data-current={lang} id="lang-dropdown">
          <button class="lang-button" id="lang-button" aria-haspopup="true" aria-expanded="false">
            <svg class="lang-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="9"></circle>
              <path d="M3 12h18"></path>
              <path d="M12 3a15 15 0 0 1 0 18"></path>
              <path d="M12 21a15 15 0 0 1 0-18"></path>
            </svg>
            {lang.toUpperCase()}
          </button>
          <div class="lang-menu" id="lang-menu" role="menu">
            {lang !== 'es' && (<a class="lang-item" role="menuitem" data-lang="es" href={toES}>🇪🇸 ES</a>)}
            {lang !== 'ca' && (
              <a class="lang-item" role="menuitem" data-lang="ca" href={toCA}>
                <img src="/images/catflag.svg" alt="CA" style="width:13px;height:13px;vertical-align:-2px;margin-right:6px;"/>CA
              </a>
            )}
            {lang !== 'en' && (<a class="lang-item" role="menuitem" data-lang="en" href={toEN}>🇬🇧 EN</a>)}
          </div>
        </div>
        <div class="buy-desktop">
          <ButtonPrimaryDark href={`${prefix}/contacto`}>
            {getHeaderTranslation('actions.talk')}
          </ButtonPrimaryDark>
        </div>
        
        <button class="menu-toggle mobile-nav" id="menu-toggle-mega">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
    
    <div class="mobile-overlay" id="mobile-overlay-mega"></div>
    <nav class="mobile-nav-menu" id="mobile-nav-mega">
      <div class="mobile-nav-header">
        <img src="/images/logo.svg" alt="Logo" class="mobile-logo" />
        <button class="mobile-close-btn" id="mobile-close-mega">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="mobile-nav-links">
        <a href={`${prefix}/`} class="mobile-nav-link">{t('nav.home')}</a>
        <div class="mobile-nav-item" id="mobile-item-servicios">
          <div class="mobile-nav-link mobile-nav-toggle">
            <span>{t('nav.servicios')}</span>
            <svg class="mobile-dropdown-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M6 9l6 6 6-6"/></svg>
          </div>
          <div class="mobile-submenu">
            <a href={`${prefix}/servicios/fiscal`} class="mobile-submenu-link">{t('nav.fiscalContable')}</a>
            <a href={`${prefix}/servicios/laboral`} class="mobile-submenu-link">{t('nav.laboral')}</a>
            <a href={`${prefix}/servicios/mercantil-societario`} class="mobile-submenu-link">{t('nav.mercantilSocietario')}</a>
            <a href={`${prefix}/servicios/sucesiones`} class="mobile-submenu-link">{t('nav.sucesiones')}</a>
          </div>
        </div>
        <a href={`${prefix}/despacho`} class="mobile-nav-link">{t('nav.despacho')}</a>
        <a href={`${prefix}/blog`} class="mobile-nav-link">Blog</a>
        <a href={`${prefix}/contacto`} class="mobile-nav-link">{getHeaderTranslation('nav.contacto')}</a>
      </div>
      <div class="mobile-nav-footer">
        <ButtonPrimaryDark href={`${prefix}/contacto`}>
          {getHeaderTranslation('actions.talk')}
        </ButtonPrimaryDark>
      </div>
    </nav>
  </div>
</header>

<script>
  const menuToggle = document.getElementById('menu-toggle-mega');
  const mobileNav = document.getElementById('mobile-nav-mega');
  const mobileOverlay = document.getElementById('mobile-overlay-mega');
  const mobileClose = document.getElementById('mobile-close-mega');

  function closeMenu() {
    if (mobileNav) mobileNav.classList.remove('active');
    if (mobileOverlay) mobileOverlay.classList.remove('active');
    document.body.classList.remove('menu-open');
    if (menuToggle) menuToggle.classList.remove('active');
  }

  function openMenu() {
    if (mobileNav) mobileNav.classList.add('active');
    if (mobileOverlay) mobileOverlay.classList.add('active');
    document.body.classList.add('menu-open');
    if (menuToggle) menuToggle.classList.add('active');
  }

  if (menuToggle && mobileNav && mobileOverlay && mobileClose) {
    mobileNav.classList.add('no-transition');
    mobileOverlay.classList.add('no-transition');
    closeMenu();
    requestAnimationFrame(() => {
      mobileNav.classList.remove('no-transition');
      mobileOverlay.classList.remove('no-transition');
    });
    menuToggle.addEventListener('click', () => {
      if (mobileNav.classList.contains('active')) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    mobileClose.addEventListener('click', closeMenu);
    mobileOverlay.addEventListener('click', closeMenu);

    const mobileLinks = mobileNav.querySelectorAll('.mobile-nav-link:not(.mobile-nav-toggle)');
    mobileLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
    
    const mobileSubmenuLinks = mobileNav.querySelectorAll('.mobile-submenu-link');
    mobileSubmenuLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
    window.addEventListener('pageshow', closeMenu);
    window.addEventListener('load', closeMenu);
    window.addEventListener('beforeunload', closeMenu);
  }

  // Dropdown de idioma simple
  (function(){
    const dropdown = document.getElementById('lang-dropdown');
    const button = document.getElementById('lang-button');
    const menu = document.getElementById('lang-menu');
    if (!dropdown || !button || !menu) return;
    function closeAll(){
      if (dropdown) dropdown.classList.remove('open');
      if (button) button.setAttribute('aria-expanded', 'false');
    }
    button && button.addEventListener('click', (e)=>{
      e.preventDefault();
      const isOpen = dropdown.classList.toggle('open');
      button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });
    document.addEventListener('click', (e)=>{
      if (!dropdown.contains(e.target as Node)) closeAll();
    });
    dropdown && dropdown.addEventListener('mouseenter', ()=>{
      dropdown.classList.add('open');
      button.setAttribute('aria-expanded', 'true');
    });
    dropdown && dropdown.addEventListener('mouseleave', ()=>{
      closeAll();
    });

    // Guardar preferencia antes de navegar
    const items = menu.querySelectorAll('.lang-item');
    items.forEach(function(el){
      el.addEventListener('click', function(this: HTMLAnchorElement){
        try {
          const targetLang = this.getAttribute('data-lang') || '';
          if (targetLang) localStorage.setItem('preferredLang', targetLang);
        } catch(e) {}
      });
    });
  })();

  // Toggle submenú móvil de Servicios
  (function(){
    const item = document.getElementById('mobile-item-servicios');
    if (!item) return;
    const toggle = item.querySelector('.mobile-nav-toggle');
    if (!toggle) return;
    toggle.addEventListener('click', function(){
      item.classList.toggle('open');
    });
  })();

  // Header scroll effect - solo para páginas con hero
  const header = document.querySelector('.header-mega');
  if (header && header.classList.contains('home-page')) {
    function updateHeader() {
      // En páginas con hero: transparente al principio, azul al hacer scroll
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }
    
    window.addEventListener('scroll', updateHeader, { passive: true });
    updateHeader(); // Initial call
  }
</script>